<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Your Glyphenge</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="create-page">
        <!-- Header -->
        <div class="create-header">
            <h1>Create Your Link Tapestry</h1>
            <span class="style-badge" id="style-badge">Stunning</span>
        </div>

        <!-- Main Content: Three Columns -->
        <div class="create-content">
            <!-- Left Column: Link Management -->
            <div class="create-column">
                <div class="input-section">
                    <h2>Your Links</h2>

                    <div class="input-tabs">
                        <button class="tab-button active" onclick="switchTab('import')">Import Links</button>
                        <button class="tab-button" onclick="switchTab('manual')">Add Manually</button>
                    </div>

                    <!-- Import Tab -->
                    <div class="tab-content active" id="import-tab">
                        <div class="form-group">
                            <label for="import-url">Import from Linktree or similar</label>
                            <input type="url" id="import-url" placeholder="https://linktr.ee/username">
                        </div>
                        <button class="add-link-button" onclick="importLinks(event)">Import Links</button>
                    </div>

                    <!-- Manual Tab -->
                    <div class="tab-content" id="manual-tab">
                        <div class="form-group">
                            <label for="link-title">Link Title</label>
                            <input type="text" id="link-title" placeholder="GitHub">
                        </div>
                        <div class="form-group">
                            <label for="link-url">Link URL</label>
                            <input type="url" id="link-url" placeholder="https://github.com/username">
                        </div>
                        <button class="add-link-button" onclick="addLink()">Add Link</button>
                    </div>

                    <!-- Link List -->
                    <div class="link-list" id="link-list"></div>
                </div>

                <!-- Buy Buttons (Below Left Panel) -->
                <div class="purchase-options">
                    <button class="buy-button web-purchase" onclick="handlePurchase()">
                        <span class="glow"></span>
                        <span class="price">$20</span>
                        <span class="action">Buy Now</span>
                    </button>
                    <button class="buy-button app-purchase" onclick="handleAppPurchase()">
                        <span class="glow"></span>
                        <span class="price">$15</span>
                        <span class="discount-badge">25% OFF</span>
                        <span class="action">Buy in App</span>
                    </button>
                </div>
            </div>

            <!-- Middle Column: Live Preview -->
            <div class="create-column">
                <div class="preview-section">
                    <h2>Preview</h2>
                    <div class="preview-container" id="preview-container">
                        <div class="preview-placeholder">
                            Add links to see your tapestry preview
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Template Carousel -->
            <div class="create-column">
                <div class="carousel-section">
                    <h2>Choose Template</h2>
                    <div class="carousel-container">
                        <div class="carousel-track" id="carousel-track"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script src="/relevant-bdos.js"></script>
    <script>
        // Get style from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const selectedStyle = urlParams.get('style') || 'stunning';

        // Update badge
        const badge = document.getElementById('style-badge');
        badge.textContent = selectedStyle.charAt(0).toUpperCase() + selectedStyle.slice(1);
        badge.className = `style-badge ${selectedStyle}`;

        // RelevantBDOs is auto-initialized by the module
        // Available methods: RelevantBDOs.get(), RelevantBDOs.clear(), etc.

        // State
        let links = [];
        let selectedTemplate = 0;
        let selectedTemplateEmojicode = null; // Track template emojicode for payment
        let stripe = null;
        let elements = null;
        let userSubmittedTemplates = []; // Will hold templates from server

        // Tab switching
        function switchTab(tab) {
            const buttons = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            buttons.forEach(btn => btn.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            if (tab === 'import') {
                buttons[0].classList.add('active');
                document.getElementById('import-tab').classList.add('active');
            } else {
                buttons[1].classList.add('active');
                document.getElementById('manual-tab').classList.add('active');
            }
        }

        // Import links
        async function importLinks(event) {
            const url = document.getElementById('import-url').value;
            if (!url) {
                alert('Please enter a URL to import from');
                return;
            }

            try {
                // Show loading state
                const importButton = event.target;
                const originalText = importButton.textContent;
                importButton.textContent = 'Importing...';
                importButton.disabled = true;

                // Call the parse endpoint
                const response = await fetch('/parse-linktree', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();

                if (data.success) {
                    // Add all imported links to the links array
                    data.links.forEach(link => {
                        links.push(link);
                    });

                    // Update UI
                    renderLinkList();
                    updatePreview();

                    // Clear input and show success
                    document.getElementById('import-url').value = '';
                    alert(`‚úÖ Successfully imported ${data.links.length} links from @${data.username}'s Linktree!`);
                } else {
                    alert(`‚ùå ${data.error}`);
                }

                // Restore button
                importButton.textContent = originalText;
                importButton.disabled = false;

            } catch (error) {
                console.error('Import error:', error);
                alert('Failed to import links. Please try again.');

                // Restore button on error
                const importButton = event.target;
                importButton.textContent = 'Import Links';
                importButton.disabled = false;
            }
        }

        // Add link manually
        function addLink() {
            const title = document.getElementById('link-title').value;
            const url = document.getElementById('link-url').value;

            if (!title || !url) {
                alert('Please enter both title and URL');
                return;
            }

            links.push({ title, url });
            renderLinkList();
            updatePreview();

            // Clear inputs
            document.getElementById('link-title').value = '';
            document.getElementById('link-url').value = '';
        }

        // Remove link
        function removeLink(index) {
            links.splice(index, 1);
            renderLinkList();
            updatePreview();
        }

        // Render link list
        function renderLinkList() {
            const listContainer = document.getElementById('link-list');
            if (links.length === 0) {
                listContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No links added yet</p>';
                return;
            }

            listContainer.innerHTML = links.map((link, index) => `
                <div class="link-item">
                    <div>
                        <strong>${link.title}</strong>
                        <br>
                        <small>${link.url}</small>
                    </div>
                    <button class="remove-link" onclick="removeLink(${index})">Remove</button>
                </div>
            `).join('');
        }

        // Template definitions for each style
        const templates = {
            stunning: [
                { name: 'Sunset', colors: ['#ff6b6b', '#ee5a6f', '#feca57'], linkColors: ['#10b981', '#3b82f6', '#8b5cf6', '#ec4899'] }
            ],
            dazzling: [
                { name: 'Rainbow', colors: ['#ff6b6b', '#feca57', '#48dbfb'], linkColors: ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3'] }
            ],
            electric: [
                { name: 'Lightning', colors: ['#00d2ff', '#3a47d5', '#4facfe'], linkColors: ['#00d2ff', '#3a47d5', '#4facfe', '#00f2fe'] }
            ],
            polished: [
                { name: 'Steel', colors: ['#2c3e50', '#4ca1af', '#536976'], linkColors: ['#4ca1af', '#536976', '#bdc3c7', '#95a5a6'] }
            ],
            professional: [
                { name: 'Corporate', colors: ['#141e30', '#243b55', '#2c3e50'], linkColors: ['#243b55', '#2c3e50', '#34495e', '#7f8c8d'] }
            ],
            captivating: [
                { name: 'Passion', colors: ['#fc466b', '#3f5efb', '#f093fb'], linkColors: ['#fc466b', '#3f5efb', '#f093fb', '#4facfe'] }
            ],
            delightful: [
                { name: 'Sunshine', colors: ['#fdbb2d', '#22c1c3', '#feca57'], linkColors: ['#fdbb2d', '#22c1c3', '#feca57', '#ee5a6f'] }
            ],
            magical: [
                { name: 'Unicorn', colors: ['#a8edea', '#fed6e3', '#f093fb'], linkColors: ['#a8edea', '#fed6e3', '#f093fb', '#ffecd2'] }
            ],
            basic: [
                { name: 'Clean', colors: ['#6a85b6', '#bac8e0', '#95a5a6'], linkColors: ['#6a85b6', '#bac8e0', '#95a5a6', '#7f8c8d'] }
            ]
        };

        // Generate live preview SVG
        function generatePreviewSVG(template, userLinks) {
            const linkCount = userLinks.length || 1;
            const height = Math.max(400, linkCount * 110 + 180);

            const gradientStops = template.colors.map((color, index) => {
                const offset = (index / (template.colors.length - 1)) * 100;
                return `<stop offset="${offset}%" style="stop-color:${color};stop-opacity:1" />`;
            }).join('');

            const linkCards = userLinks.map((link, i) => {
                const color = template.linkColors[i % template.linkColors.length];
                const colorDark = shadeColor(color, -20);

                return `
                    <defs>
                        <linearGradient id="linkGrad${i}" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:${color};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${colorDark};stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <g transform="translate(50, ${140 + i * 100})">
                        <rect width="500" height="80" fill="url(#linkGrad${i})" rx="12" opacity="0.95"/>
                        <circle cx="40" cy="40" r="25" fill="white" opacity="0.3"/>
                        <text x="80" y="35" font-family="system-ui" font-size="16" font-weight="600" fill="white">${escapeXML(link.title)}</text>
                        <text x="80" y="55" font-family="system-ui" font-size="14" fill="white" opacity="0.9">${escapeXML(getDomain(link.url))}</text>
                        <text x="460" y="45" font-family="system-ui" font-size="24" fill="white" opacity="0.6">‚Üí</text>
                    </g>
                `;
            }).join('');

            return `
                <svg viewBox="0 0 600 ${height}" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="bg-${template.name}" x1="0%" y1="0%" x2="0%" y2="100%">
                            ${gradientStops}
                        </linearGradient>
                    </defs>
                    <rect width="600" height="${height}" fill="url(#bg-${template.name})" rx="20"/>
                    <text x="300" y="80" font-family="system-ui" font-size="32" font-weight="bold" fill="white" text-anchor="middle">
                        Your Awesome Links
                    </text>
                    ${linkCards}
                    <text x="300" y="${height - 50}" font-size="48" text-anchor="middle" opacity="0.7">‚ú®</text>
                </svg>
            `;
        }

        // Generate template card SVG (smaller, for carousel)
        function generateTemplateSVG(template) {
            const gradientStops = template.colors.map((color, index) => {
                const offset = (index / (template.colors.length - 1)) * 100;
                return `<stop offset="${offset}%" style="stop-color:${color};stop-opacity:1" />`;
            }).join('');

            return `
                <svg viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="tmpl-${template.name}" x1="0%" y1="0%" x2="0%" y2="100%">
                            ${gradientStops}
                        </linearGradient>
                    </defs>
                    <rect width="600" height="400" fill="url(#tmpl-${template.name})" rx="20"/>
                    <text x="300" y="200" font-family="system-ui" font-size="28" font-weight="bold" fill="white" text-anchor="middle" opacity="0.9">
                        ${template.name}
                    </text>
                </svg>
            `;
        }

        // Update live preview
        function updatePreview() {
            const container = document.getElementById('preview-container');

            // Get template from either built-in or user-submitted
            let template;
            if (selectedTemplateEmojicode) {
                // User template selected
                const userTemplateIndex = userSubmittedTemplates.findIndex(t => t.emojicode === selectedTemplateEmojicode);
                template = userSubmittedTemplates[userTemplateIndex];
            } else {
                // Built-in template selected
                const styleTemplates = templates[selectedStyle] || templates.stunning;
                template = styleTemplates[selectedTemplate];
            }

            if (links.length === 0) {
                container.innerHTML = '<div class="preview-placeholder">Add links to see your tapestry preview</div>';
            } else {
                container.innerHTML = generatePreviewSVG(template, links);
            }
        }

        // Render carousel
        function renderCarousel() {
            const track = document.getElementById('carousel-track');
            const styleTemplates = templates[selectedStyle] || templates.stunning;

            // Render built-in templates
            const builtInTemplateCards = styleTemplates.map((template, index) => `
                <div class="template-card ${index === selectedTemplate && !selectedTemplateEmojicode ? 'selected' : ''}" onclick="selectBuiltInTemplate(${index})">
                    ${generateTemplateSVG(template)}
                </div>
            `).join('');

            // Render user-submitted templates
            const userTemplateCards = userSubmittedTemplates.map((template, index) => {
                const isSelected = selectedTemplateEmojicode === template.emojicode;
                return `
                    <div class="template-card ${isSelected ? 'selected' : ''}" onclick='selectUserTemplate(${index}, "${template.emojicode}")'>
                        ${generateTemplateSVG(template)}
                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(16, 185, 129, 0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            Community
                        </div>
                    </div>
                `;
            }).join('');

            const customTemplateCard = `
                <div class="template-card" onclick="showTemplateOptions()" style="cursor: pointer;">
                    <svg viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="custom-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect width="600" height="400" fill="url(#custom-gradient)" rx="20"/>
                        <text x="300" y="180" font-family="system-ui" font-size="24" font-weight="bold" fill="white" text-anchor="middle" opacity="0.9">
                            Custom Templates
                        </text>
                        <text x="300" y="220" font-family="system-ui" font-size="16" fill="white" text-anchor="middle" opacity="0.8">
                            Download spec or upload your own
                        </text>
                        <text x="300" y="250" font-family="system-ui" font-size="32" fill="white" text-anchor="middle" opacity="0.9">
                            ‚öôÔ∏è
                        </text>
                    </svg>
                </div>
            `;

            track.innerHTML = builtInTemplateCards + userTemplateCards + customTemplateCard;
        }

        // Select built-in template
        function selectBuiltInTemplate(index) {
            selectedTemplate = index;
            selectedTemplateEmojicode = null; // Clear user template selection
            renderCarousel();
            updatePreview();

            // Clear template from relevantBDOs
            RelevantBDOs.removeByEmojicode(selectedTemplateEmojicode);
        }

        // Select user-submitted template
        function selectUserTemplate(index, emojicode) {
            selectedTemplate = index;
            selectedTemplateEmojicode = emojicode;
            renderCarousel();

            // Get template from userSubmittedTemplates
            const template = userSubmittedTemplates[index];
            updatePreview();

            // Add template emojicode to relevantBDOs for payment sharing
            console.log(`üé® Selected user template: ${template.name} (${emojicode})`);
            RelevantBDOs.addEmojicode(emojicode);
        }

        // Scroll carousel
        function scrollCarousel(direction) {
            const track = document.getElementById('carousel-track');
            const scrollAmount = 320;
            track.scrollBy({
                left: direction * scrollAmount,
                behavior: 'smooth'
            });
        }

        // Helper: Shade color
        function shadeColor(color, percent) {
            const num = parseInt(color.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
        }

        // Helper: Get domain from URL
        function getDomain(url) {
            try {
                const domain = new URL(url).hostname.replace('www.', '');
                return domain;
            } catch {
                return url;
            }
        }

        // Helper: Escape XML
        function escapeXML(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // Fetch user-submitted templates from server
        async function fetchUserSubmittedTemplates() {
            try {
                console.log('üé® Fetching user-submitted templates...');
                const response = await fetch('/templates');
                const data = await response.json();

                if (data.success && data.templates) {
                    userSubmittedTemplates = data.templates;
                    console.log(`‚úÖ Loaded ${userSubmittedTemplates.length} user-submitted templates`);
                } else {
                    console.log('‚ÑπÔ∏è No user-submitted templates available yet');
                }
            } catch (error) {
                console.error('‚ùå Error fetching user templates:', error);
            }
        }

        // Handle purchase
        async function handlePurchase() {
            if (links.length === 0) {
                alert('Please add at least one link before purchasing');
                return;
            }

            try {
                console.log('üí≥ Creating payment intent...');

                // Get relevantBDOs from module to include in payment
                const relevantBDOs = RelevantBDOs.get();
                console.log('üì¶ Including relevantBDOs in payment:', relevantBDOs);

                const response = await fetch('/create-payment-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ relevantBDOs })
                });

                if (!response.ok) {
                    throw new Error('Failed to create payment intent');
                }

                const { clientSecret, publishableKey } = await response.json();

                console.log('‚úÖ Payment intent created');

                stripe = Stripe(publishableKey);
                elements = stripe.elements({ clientSecret: clientSecret });

                const paymentElement = elements.create('payment');
                showPaymentModal(paymentElement);

            } catch (error) {
                console.error('‚ùå Payment error:', error);
                alert('Payment failed. Please try again.');
            }
        }

        function showPaymentModal(paymentElement) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: flex-start;
                justify-content: center;
                z-index: 10000;
                overflow-y: auto;
                padding: 40px 20px;
            `;

            const formContainer = document.createElement('div');
            formContainer.style.cssText = `
                background: white;
                padding: 40px;
                border-radius: 20px;
                max-width: 500px;
                width: 90%;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                margin: auto;
            `;

            formContainer.innerHTML = `
                <h2 style="margin: 0 0 10px 0; color: #333;">Complete Purchase</h2>
                <p style="margin: 0 0 30px 0; color: #666;">$20.00 for your Glyphenge Tapestry</p>
                <div id="payment-element" style="margin-bottom: 20px;"></div>
                <button id="submit-payment" style="
                    width: 100%;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    border: none;
                    padding: 15px;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    margin-bottom: 10px;
                ">Pay $20</button>
                <button id="cancel-payment" style="
                    width: 100%;
                    background: #e5e7eb;
                    color: #666;
                    border: none;
                    padding: 15px;
                    border-radius: 10px;
                    font-size: 16px;
                    cursor: pointer;
                ">Cancel</button>
                <div id="payment-message" style="
                    margin-top: 20px;
                    padding: 10px;
                    border-radius: 5px;
                    display: none;
                "></div>
            `;

            modal.appendChild(formContainer);
            document.body.appendChild(modal);

            paymentElement.mount('#payment-element');

            document.getElementById('submit-payment').addEventListener('click', async () => {
                const submitButton = document.getElementById('submit-payment');
                submitButton.disabled = true;
                submitButton.textContent = 'Processing...';

                try {
                    // Confirm payment (handle success inline, no redirect)
                    const { error } = await stripe.confirmPayment({
                        elements,
                        redirect: 'if_required'
                    });

                    if (error) {
                        showMessage(error.message, 'error');
                        submitButton.disabled = false;
                        submitButton.textContent = 'Pay $20';
                    } else {
                        // Payment succeeded! Now create the tapestry
                        submitButton.textContent = 'Creating Tapestry...';

                        try {
                            const createResponse = await fetch('/create', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    title: 'My Glyphenge',
                                    links: links,
                                    source: 'create-page',
                                    style: selectedStyle
                                })
                            });

                            if (!createResponse.ok) {
                                throw new Error('Failed to create tapestry');
                            }

                            const tapestryData = await createResponse.json();

                            // Close payment modal
                            document.body.removeChild(modal);

                            // Clear relevantBDOs after successful purchase
                            RelevantBDOs.clear();

                            // Show success with emojicode
                            showSuccessPage(tapestryData);

                        } catch (createError) {
                            showMessage('Payment successful but tapestry creation failed. Please contact support.', 'error');
                            submitButton.disabled = false;
                            submitButton.textContent = 'Pay $20';
                        }
                    }
                } catch (err) {
                    showMessage('Payment failed. Please try again.', 'error');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Pay $20';
                }
            });

            document.getElementById('cancel-payment').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        // Handle app purchase (triggers authteam flow)
        async function handleAppPurchase() {
            if (links.length === 0) {
                alert('Please add at least one link before purchasing');
                return;
            }

            try {
                console.log('üì± Creating handoff for app purchase...');

                // Get relevantBDOs to pass to the handoff
                const relevantBDOs = RelevantBDOs.get();
                const styleTemplates = templates[selectedStyle] || templates.stunning;
                const template = styleTemplates[selectedTemplate];

                // Create the BDO data that will be passed to the app
                const bdoData = {
                    title: 'My Glyphenge',
                    links: links,
                    source: 'create-page',
                    style: selectedStyle,
                    template: template.name
                };

                const response = await fetch('/handoff/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bdoData,
                        relevantBDOs,
                        productType: 'linkitylink'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create handoff');
                }

                const handoffData = await response.json();
                console.log('‚úÖ Handoff created:', handoffData);

                // Show authteam modal
                showAuthteamModal(handoffData);

            } catch (error) {
                console.error('‚ùå Handoff error:', error);
                alert('Failed to start app handoff. Please try again.');
            }
        }

        // Authteam color sequence modal
        function showAuthteamModal(handoffData) {
            const { token, sequence, webPrice, appPrice, discount, discountPercent, expiresAt } = handoffData;

            // Color definitions
            const colorMap = {
                red: '#ef4444',
                blue: '#3b82f6',
                green: '#22c55e',
                yellow: '#eab308',
                purple: '#a855f7',
                orange: '#f97316'
            };

            const modal = document.createElement('div');
            modal.className = 'authteam-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                padding: 40px;
                border-radius: 20px;
                max-width: 500px;
                width: 100%;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                text-align: center;
                color: white;
            `;

            content.innerHTML = `
                <h2 style="margin: 0 0 10px 0; color: #fff; font-size: 1.8rem;">Connect to The Advancement</h2>
                <p style="margin: 0 0 20px 0; color: #94a3b8; font-size: 1rem;">
                    Match the color sequence shown in the app to verify your device
                </p>

                <!-- Discount banner -->
                <div style="
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    padding: 15px;
                    border-radius: 10px;
                    margin-bottom: 25px;
                ">
                    <span style="font-size: 1.2rem; font-weight: bold;">Save $${(discount / 100).toFixed(2)}</span>
                    <span style="opacity: 0.9;"> (${discountPercent}% off)</span>
                </div>

                <!-- Sequence display -->
                <div style="margin-bottom: 25px;">
                    <p style="color: #94a3b8; margin-bottom: 10px; font-size: 0.9rem;">Enter this sequence in the app:</p>
                    <div id="sequence-display" style="
                        display: flex;
                        justify-content: center;
                        gap: 10px;
                        padding: 20px;
                        background: rgba(255,255,255,0.05);
                        border-radius: 15px;
                    ">
                        ${sequence.map(color => `
                            <div style="
                                width: 50px;
                                height: 50px;
                                background: ${colorMap[color]};
                                border-radius: 10px;
                                box-shadow: 0 4px 15px ${colorMap[color]}40;
                            " title="${color}"></div>
                        `).join('')}
                    </div>
                </div>

                <!-- Status -->
                <div id="handoff-status" style="
                    padding: 15px;
                    background: rgba(255,255,255,0.05);
                    border-radius: 10px;
                    margin-bottom: 20px;
                ">
                    <p style="margin: 0; color: #fbbf24;">
                        ‚è≥ Waiting for app verification...
                    </p>
                    <p style="margin: 5px 0 0 0; color: #94a3b8; font-size: 0.8rem;">
                        Open The Advancement app and tap "Connect to Web"
                    </p>
                </div>

                <!-- Instructions -->
                <div style="
                    text-align: left;
                    padding: 15px;
                    background: rgba(255,255,255,0.05);
                    border-radius: 10px;
                    margin-bottom: 20px;
                ">
                    <p style="margin: 0 0 10px 0; color: #fff; font-weight: 600;">How it works:</p>
                    <ol style="margin: 0; padding-left: 20px; color: #94a3b8; font-size: 0.9rem;">
                        <li style="margin-bottom: 8px;">Open The Advancement app on your phone</li>
                        <li style="margin-bottom: 8px;">Tap "Connect to Web" or scan the QR code</li>
                        <li style="margin-bottom: 8px;">Enter the color sequence shown above</li>
                        <li style="margin-bottom: 0;">Complete purchase in the app for $${(appPrice / 100).toFixed(2)}</li>
                    </ol>
                </div>

                <!-- Token for manual entry -->
                <div style="margin-bottom: 20px;">
                    <p style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px;">Handoff code (for manual entry):</p>
                    <code style="
                        background: rgba(255,255,255,0.1);
                        padding: 8px 15px;
                        border-radius: 5px;
                        font-family: monospace;
                        font-size: 0.9rem;
                        user-select: all;
                        cursor: pointer;
                    " onclick="navigator.clipboard.writeText('${token}')" title="Click to copy">${token.substring(0, 16)}...</code>
                </div>

                <!-- Buttons -->
                <div style="display: flex; gap: 10px;">
                    <button id="pay-web-instead" style="
                        flex: 1;
                        background: #374151;
                        color: white;
                        border: none;
                        padding: 15px;
                        border-radius: 10px;
                        font-size: 14px;
                        cursor: pointer;
                    ">Pay $${(webPrice / 100).toFixed(2)} on Web Instead</button>
                    <button id="cancel-handoff" style="
                        flex: 1;
                        background: #4b5563;
                        color: white;
                        border: none;
                        padding: 15px;
                        border-radius: 10px;
                        font-size: 14px;
                        cursor: pointer;
                    ">Cancel</button>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Store handoff data for polling
            window.currentHandoff = {
                token,
                modal,
                pollInterval: null
            };

            // Start polling for handoff completion
            startHandoffPolling(token, modal);

            // Button handlers
            document.getElementById('pay-web-instead').addEventListener('click', () => {
                stopHandoffPolling();
                document.body.removeChild(modal);
                handlePurchase(); // Switch to web purchase
            });

            document.getElementById('cancel-handoff').addEventListener('click', () => {
                stopHandoffPolling();
                document.body.removeChild(modal);
            });
        }

        // Poll for handoff completion
        function startHandoffPolling(token, modal) {
            const statusEl = modal.querySelector('#handoff-status');

            window.currentHandoff.pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/handoff/${token}/status`);
                    if (!response.ok) {
                        throw new Error('Handoff expired or not found');
                    }

                    const data = await response.json();

                    if (data.sequenceCompleted && data.appPubKey) {
                        // App has verified and associated
                        statusEl.innerHTML = `
                            <p style="margin: 0; color: #22c55e;">
                                ‚úÖ App connected successfully!
                            </p>
                            <p style="margin: 5px 0 0 0; color: #94a3b8; font-size: 0.8rem;">
                                Complete purchase in The Advancement app
                            </p>
                        `;
                    } else if (data.sequenceCompleted) {
                        // Sequence verified, waiting for app association
                        statusEl.innerHTML = `
                            <p style="margin: 0; color: #3b82f6;">
                                üîÑ Sequence verified, connecting app...
                            </p>
                        `;
                    }

                    if (data.completedAt) {
                        // Purchase completed in app!
                        stopHandoffPolling();
                        document.body.removeChild(modal);

                        // Clear relevantBDOs
                        RelevantBDOs.clear();

                        // Show success
                        showAppPurchaseSuccess(data);
                    }

                } catch (error) {
                    console.log('Handoff polling error:', error.message);
                    // Don't stop polling on minor errors
                }
            }, 2000); // Poll every 2 seconds
        }

        function stopHandoffPolling() {
            if (window.currentHandoff && window.currentHandoff.pollInterval) {
                clearInterval(window.currentHandoff.pollInterval);
                window.currentHandoff.pollInterval = null;
            }
        }

        // Show success after app purchase
        function showAppPurchaseSuccess(data) {
            const { emojicode, bdoPubKey } = data;

            // Construct URLs
            const emojicodeUrl = emojicode
                ? `${window.location.origin}?emojicode=${encodeURIComponent(emojicode)}`
                : null;
            const alphanumericUrl = bdoPubKey
                ? `${window.location.origin}/t/${bdoPubKey.substring(0, 16)}`
                : null;

            document.body.innerHTML = `
                <div style="
                    min-height: 100vh;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                ">
                    <div style="
                        background: white;
                        border-radius: 20px;
                        padding: 60px 40px;
                        max-width: 600px;
                        width: 100%;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        text-align: center;
                    ">
                        <div style="font-size: 64px; margin-bottom: 20px;">üì±‚ú®</div>
                        <h1 style="color: #333; margin-bottom: 10px; font-size: 2rem;">Purchase Complete!</h1>
                        <p style="color: #666; margin-bottom: 20px; font-size: 1.1rem;">
                            Your tapestry was purchased in The Advancement app
                        </p>
                        <p style="color: #10b981; margin-bottom: 40px; font-size: 1rem; font-weight: 600;">
                            You saved 25% with the app discount!
                        </p>

                        ${emojicode ? `
                        <!-- Emojicode -->
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            border-radius: 15px;
                            margin-bottom: 30px;
                        ">
                            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">Your Emojicode</div>
                            <div style="
                                font-size: 2rem;
                                font-family: monospace;
                                letter-spacing: 2px;
                            ">${emojicode}</div>
                        </div>
                        ` : ''}

                        ${emojicodeUrl ? `
                        <div style="margin-bottom: 30px;">
                            <a href="${emojicodeUrl}" style="
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                color: white;
                                padding: 15px 30px;
                                border-radius: 10px;
                                text-decoration: none;
                                font-weight: 600;
                                display: inline-block;
                            ">View Your Tapestry</a>
                        </div>
                        ` : ''}

                        <p style="color: #666; font-size: 0.9rem;">
                            Your tapestry is now in your carrierBag in The Advancement app.
                        </p>

                        <a href="/create" style="
                            color: #10b981;
                            text-decoration: none;
                            font-weight: 600;
                            margin-top: 20px;
                            display: inline-block;
                        ">Create Another Tapestry</a>
                    </div>
                </div>
            `;
        }

        function showMessage(message, type) {
            const messageElement = document.getElementById('payment-message');
            messageElement.textContent = message;
            messageElement.style.display = 'block';
            messageElement.style.background = type === 'error' ? '#fee2e2' : '#d1fae5';
            messageElement.style.color = type === 'error' ? '#991b1b' : '#065f46';
        }

        // Show success page with emojicode and URLs
        function showSuccessPage(tapestryData) {
            const { emojicode, pubKey, uuid } = tapestryData;

            // Construct URLs (client constructs, server doesn't)
            const emojicodeUrl = `${window.location.origin}?emojicode=${encodeURIComponent(emojicode)}`;
            const alphanumericUrl = `${window.location.origin}/t/${pubKey.substring(0, 16)}`;
            const bdoUrl = `http://localhost:3003/emoji/${encodeURIComponent(emojicode)}`;

            // Replace entire page with success view
            document.body.innerHTML = `
                <div style="
                    min-height: 100vh;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                ">
                    <div style="
                        background: white;
                        border-radius: 20px;
                        padding: 60px 40px;
                        max-width: 600px;
                        width: 100%;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        text-align: center;
                    ">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚ú®</div>
                        <h1 style="color: #333; margin-bottom: 10px; font-size: 2rem;">Your Tapestry is Ready!</h1>
                        <p style="color: #666; margin-bottom: 40px; font-size: 1.1rem;">Share your magical link tapestry with the world</p>

                        <!-- Emojicode -->
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            border-radius: 15px;
                            margin-bottom: 30px;
                        ">
                            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">Your Emojicode</div>
                            <div style="
                                font-size: 2rem;
                                font-family: monospace;
                                letter-spacing: 2px;
                                cursor: pointer;
                                padding: 10px;
                                background: rgba(255,255,255,0.1);
                                border-radius: 8px;
                            " onclick="copyToClipboard('${emojicode}', this)" title="Click to copy">
                                ${emojicode}
                            </div>
                            <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 8px;">üëÜ Click to copy</div>
                        </div>

                        <!-- URLs -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #333; margin-bottom: 15px; font-size: 1.2rem;">Share Your Links</h3>

                            <!-- Emojicode URL -->
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 5px;">Emojicode URL (Persistent)</label>
                                <div style="
                                    background: #f3f4f6;
                                    padding: 12px;
                                    border-radius: 8px;
                                    font-family: monospace;
                                    font-size: 0.85rem;
                                    word-break: break-all;
                                    cursor: pointer;
                                    border: 2px solid transparent;
                                    transition: border-color 0.2s;
                                " onclick="copyToClipboard('${emojicodeUrl}', this)">
                                    ${emojicodeUrl}
                                </div>
                            </div>

                            <!-- Alphanumeric URL -->
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 5px;">Browser-Friendly URL</label>
                                <div style="
                                    background: #f3f4f6;
                                    padding: 12px;
                                    border-radius: 8px;
                                    font-family: monospace;
                                    font-size: 0.85rem;
                                    word-break: break-all;
                                    cursor: pointer;
                                    border: 2px solid transparent;
                                    transition: border-color 0.2s;
                                " onclick="copyToClipboard('${alphanumericUrl}', this)">
                                    ${alphanumericUrl}
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <a href="${emojicodeUrl}" style="
                                flex: 1;
                                min-width: 200px;
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                color: white;
                                padding: 15px 30px;
                                border-radius: 10px;
                                text-decoration: none;
                                font-weight: 600;
                                display: inline-block;
                                transition: transform 0.2s, box-shadow 0.2s;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 30px rgba(16, 185, 129, 0.4)'"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(16, 185, 129, 0.3)'">
                                View Your Tapestry
                            </a>
                            <a href="/create" style="
                                flex: 1;
                                min-width: 200px;
                                background: #e5e7eb;
                                color: #333;
                                padding: 15px 30px;
                                border-radius: 10px;
                                text-decoration: none;
                                font-weight: 600;
                                display: inline-block;
                                transition: transform 0.2s;
                            " onmouseover="this.style.transform='translateY(-2px)'"
                               onmouseout="this.style.transform='translateY(0)'">
                                Create Another
                            </a>
                        </div>

                        <!-- Footer Note -->
                        <p style="color: #999; font-size: 0.85rem; margin-top: 30px;">
                            üíæ Your tapestry is saved to your session and can be accessed anytime
                        </p>
                    </div>
                </div>

                <script>
                    function copyToClipboard(text, element) {
                        navigator.clipboard.writeText(text).then(() => {
                            const originalBorder = element.style.border;
                            element.style.border = '2px solid #10b981';
                            setTimeout(() => {
                                element.style.border = originalBorder;
                            }, 1000);
                        });
                    }
                <\/script>
            `;
        }

        // Template Options Modal
        function showTemplateOptions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 40px;
                border-radius: 20px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;

            content.innerHTML = `
                <h2 style="margin: 0 0 10px 0; color: #333;">Template Options</h2>
                <p style="margin: 0 0 30px 0; color: #666;">Download template spec or upload your own</p>

                <button onclick="downloadTemplateSpec()" style="
                    width: 100%;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    border: none;
                    padding: 15px;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    margin-bottom: 10px;
                ">Download Template Spec</button>

                <button onclick="showUploadTemplateForm()" style="
                    width: 100%;
                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                    color: white;
                    border: none;
                    padding: 15px;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    margin-bottom: 10px;
                ">Upload Custom Template</button>

                <button onclick="this.closest('.modal').remove()" style="
                    width: 100%;
                    background: #e5e7eb;
                    color: #666;
                    border: none;
                    padding: 15px;
                    border-radius: 10px;
                    font-size: 16px;
                    cursor: pointer;
                ">Cancel</button>
            `;

            content.querySelector('button[onclick*="remove"]').onclick = () => {
                document.body.removeChild(modal);
            };

            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Download Template Specification
        function downloadTemplateSpec() {
            const templateSpec = {
                _documentation: {
                    description: "Glyphenge Custom Template Specification",
                    version: "1.0",
                    revenue: "Earn 2% of every $20 purchase using your template",
                    requirements: {
                        container: "SVG container with dynamic \\${height} placeholder",
                        linkTemplate: "Must include <a href=\\\"\\${url}\\\" target=\\\"_blank\\\"> wrapper",
                        placeholders: [
                            "\\${height} - Dynamic height based on link count",
                            "\\${url} - Link URL",
                            "\\${title} - Link title",
                            "\\${domain} - Extracted domain name",
                            "\\${index} or \\${i} - Link index (0-based)"
                        ]
                    }
                },
                name: "My Custom Template",
                colors: ["#ff6b6b", "#ee5a6f", "#feca57"],
                linkColors: ["#10b981", "#3b82f6", "#8b5cf6", "#ec4899"],
                background: `<svg viewBox="0 0 600 \${height}" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <linearGradient id="bg" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#ff6b6b;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#ee5a6f;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#feca57;stop-opacity:1" />
        </linearGradient>
    </defs>
    <rect width="600" height="\${height}" fill="url(#bg)" rx="20"/>
</svg>`,
                linkTemplate: `<a href="\${url}" target="_blank">
    <rect x="50" y="\${y}" width="500" height="80" fill="\${color}" rx="12" opacity="0.95"/>
    <text x="80" y="\${y + 35}" font-family="system-ui" font-size="16" fill="white">\${title}</text>
    <text x="80" y="\${y + 55}" font-family="system-ui" font-size="14" fill="white" opacity="0.9">\${domain}</text>
</a>`
            };

            const blob = new Blob([JSON.stringify(templateSpec, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'glyphenge-template.json';
            a.click();
            URL.revokeObjectURL(url);

            // Close modal
            document.querySelector('.modal').remove();
        }

        // Show Upload Template Form
        function showUploadTemplateForm() {
            // Close current modal
            document.querySelector('.modal').remove();

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 40px;
                border-radius: 20px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;

            content.innerHTML = `
                <h2 style="margin: 0 0 10px 0; color: #333;">Upload Custom Template</h2>
                <p style="margin: 0 0 20px 0; color: #666;">Upload your template JSON file</p>

                <div style="margin-bottom: 20px;">
                    <input type="file" id="template-file" accept=".json" style="
                        width: 100%;
                        padding: 10px;
                        border: 2px dashed #d1d5db;
                        border-radius: 10px;
                        cursor: pointer;
                    ">
                </div>

                <button id="upload-template-btn" style="
                    width: 100%;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    border: none;
                    padding: 15px;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    margin-bottom: 10px;
                ">Upload Template</button>

                <button onclick="this.closest('.modal').remove()" style="
                    width: 100%;
                    background: #e5e7eb;
                    color: #666;
                    border: none;
                    padding: 15px;
                    border-radius: 10px;
                    font-size: 16px;
                    cursor: pointer;
                ">Cancel</button>
            `;

            content.querySelector('button[onclick*="remove"]').onclick = () => {
                document.body.removeChild(modal);
            };

            content.querySelector('#upload-template-btn').onclick = () => {
                uploadTemplate();
            };

            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Upload Template
        async function uploadTemplate() {
            const fileInput = document.getElementById('template-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a template file');
                return;
            }

            try {
                const text = await file.text();
                const template = JSON.parse(text);

                // Validate template structure
                if (!template.name || !template.colors || !template.linkColors || !template.background || !template.linkTemplate) {
                    alert('Invalid template format. Please check the specification.');
                    return;
                }

                // Add to templates (would normally upload to server)
                console.log('Custom template uploaded:', template);
                alert('Template uploaded successfully! (Server upload not yet implemented)');

                // Close modal
                document.querySelector('.modal').remove();

            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to parse template file. Please check the format.');
            }
        }


        // Initialize - fetch user templates then render UI
        async function initialize() {
            await fetchUserSubmittedTemplates();
            renderCarousel();
            renderLinkList();
            updatePreview();
        }
        initialize();
    </script>
</body>
</html>
